<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>СОТА v0.2.5a — Бот и Общий Чат</title>
<style>
  /* Стили для всего тела */
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f0f0f0;
  }

  h1 {
    text-align: center;
  }

  /* Общий контейнер для бот-чата и общего чата */
  .chat-wrapper {
    max-width: 400px;
    margin: 0 auto;
  }

  /* Контейнер для каждого чата */
  .chat-container {
    display: flex;
    flex-direction: column;
    height: 450px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: white;
    padding: 10px;
    box-sizing: border-box;
    margin-bottom: 10px;
  }

  /* Скроллируемая область сообщений */
  .messages {
    flex-grow: 1;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
    background: #fafafa;
    margin-bottom: 10px;
    border-radius: 4px;
    font-size: 14px;
  }

  /* Ввод и кнопка */
  .input-row {
    display: flex;
    gap: 5px;
  }

  input[type="text"] {
    flex-grow: 1;
    padding: 8px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #aaa;
  }

  button {
    padding: 8px 15px;
    font-size: 14px;
    border: none;
    border-radius: 4px;
    background-color: #0057b7;
    color: white;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
  }

  button:hover {
    background-color: #004494;
  }

  /* Кнопка переключения */
  #toggle-chat-btn {
    display: block;
    width: 100%;
    margin: 0 auto 20px auto;
  }

  /* Скрывать чат */
  .hidden {
    display: none;
  }

</style>
</head>
<body>

<h1>СОТА v0.2.5a</h1>

<div class="chat-wrapper">

  <!-- Бот чат -->
  <section id="bot-container" class="chat-container">
    <div id="bot-messages" class="messages" aria-live="polite" aria-atomic="false" role="log"></div>
    <div class="input-row">
      <input id="bot-input" type="text" autocomplete="off" placeholder="Введите сообщение боту..." aria-label="Сообщение боту" />
      <button id="bot-send-btn" aria-label="Отправить сообщение боту">Отправить</button>
    </div>
  </section>

  <!-- Общий чат -->
  <section id="chat-container" class="chat-container hidden" aria-live="polite" aria-atomic="false" role="log">
    <div id="chat-messages" class="messages"></div>
    <div class="input-row">
      <input id="chat-input" type="text" autocomplete="off" placeholder="Введите сообщение..." aria-label="Сообщение в общий чат" />
      <button id="chat-send-btn" aria-label="Отправить сообщение в общий чат">Отправить</button>
    </div>
  </section>

  <!-- Кнопка переключения между ботом и чатом -->
  <button id="toggle-chat-btn" aria-pressed="false" aria-label="Переключить между ботом и чатом">Переключить чат</button>

</div>

<script type="module">
  /* Импортируем необходимые функции из файлов */
  import { sendMessage as sendBotMessage } from './core.js';        // твой бот (предполагается, что sendMessage возвращает ответ)
  import { connectWS, sendWSMessage, setOnMessageCallback } from './chat_ws.js'; // WebSocket для чата

  // Элементы интерфейса
  const botContainer = document.getElementById('bot-container');
  const botMessages = document.getElementById('bot-messages');
  const botInput = document.getElementById('bot-input');
  const botSendBtn = document.getElementById('bot-send-btn');

  const chatContainer = document.getElementById('chat-container');
  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');

  const toggleChatBtn = document.getElementById('toggle-chat-btn');

  // Состояние отображения чата
  let chatVisible = false;

  // Добавляем сообщение в окно бота
  function addMessageToBot(sender, text) {
    const div = document.createElement('div');
    div.textContent = `${sender}: ${text}`;
    botMessages.appendChild(div);
    botMessages.scrollTop = botMessages.scrollHeight;
  }

  // Отправка сообщения боту и получение ответа
  async function sendBot() {
    const text = botInput.value.trim();
    if (!text) return;
    addMessageToBot('Я', text);
    botInput.value = '';
    try {
      const reply = await sendBotMessage(text);
      addMessageToBot('СОТА', reply);
    } catch (e) {
      addMessageToBot('СОТА', 'Ошибка при получении ответа.');
      console.error(e);
    }
  }

  // Обработчики для отправки сообщения боту
  botSendBtn.addEventListener('click', sendBot);
  botInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      sendBot();
      e.preventDefault();
    }
  });

  // Добавляем сообщение в общий чат
  function addMessageToChat(sender, text) {
    const div = document.createElement('div');
    div.textContent = `${sender}: ${text}`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Переключение между ботом и чатом
  toggleChatBtn.addEventListener('click', () => {
    chatVisible = !chatVisible;
    if (chatVisible) {
      chatContainer.classList.remove('hidden');
      botContainer.classList.add('hidden');
      toggleChatBtn.textContent = 'Вернуться к боту';
      toggleChatBtn.setAttribute('aria-pressed', 'true');
    } else {
      chatContainer.classList.add('hidden');
      botContainer.classList.remove('hidden');
      toggleChatBtn.textContent = 'Переключить чат';
      toggleChatBtn.setAttribute('aria-pressed', 'false');
    }
  });

  // Отправка сообщения в общий чат
  chatSendBtn.addEventListener('click', () => {
    const text = chatInput.value.trim();
    if (!text) return;
    addMessageToChat('Я', text);
    sendWSMessage(text);
    chatInput.value = '';
  });

  // Отправка по Enter в общем чате
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      chatSendBtn.click();
      e.preventDefault();
    }
  });

  // Обработка входящих сообщений из WebSocket
  setOnMessageCallback((data) => {
    addMessageToChat('Другой', data);
  });

  // Подключаемся к WebSocket серверу
  connectWS();

</script>

</body>
</html>